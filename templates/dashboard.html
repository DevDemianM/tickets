{% extends "base.html" %}
{% block title %}Dashboard Técnico{% endblock %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@coreui/coreui@5.0.0/dist/css/coreui.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">

<div class="container-fluid py-4">
  <!-- Título del Dashboard -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center flex-column flex-sm-row text-center text-sm-start">
        <i class="fa fa-tachometer-alt fa-2x text-primary me-0 me-sm-3 mb-2 mb-sm-0"></i>
        <div>
          <h1 class="mb-0 fw-bold fs-2 fs-md-1">Dashboard de Tickets</h1>
          <p class="text-muted mb-0 small">Panel de control y métricas del sistema de tickets</p>
        </div>
      </div>
      <hr class="my-3">
    </div>
  </div>

  <!-- Selector de fechas y controles -->
  <div class="controls-section mb-5">
    <div class="row align-items-center">
      <div class="col-12 col-lg-8 mb-3 mb-lg-0">
        <div class="period-selector">
          <div class="period-buttons" id="date-range-selector">
            <button class="period-btn active" data-period="today">
              <span class="period-label">Hoy</span>
            </button>
            <button class="period-btn" data-period="week">
              <span class="period-label">Semana</span>
            </button>
            <button class="period-btn" data-period="month">
              <span class="period-label">Mes</span>
            </button>
            <button class="period-btn" data-period="year">
              <span class="period-label">Año</span>
            </button>
            <button class="period-btn" data-period="all">
              <span class="period-label">Todo</span>
            </button>
            <button class="period-btn period-custom" id="custom-range-btn">
              <i class="fa fa-calendar-alt"></i>
              <span class="period-label d-none d-md-inline">Personalizado</span>
            </button>
          </div>
        </div>
        
        <div class="custom-range-container d-none" id="custom-range-picker">
          <div class="custom-range-content">
            <div class="date-input-group">
              <label class="date-label">Desde</label>
              <input type="date" id="start-date" class="modern-date-input">
            </div>
            <div class="date-separator">
              <i class="fa fa-arrow-right"></i>
            </div>
            <div class="date-input-group">
              <label class="date-label">Hasta</label>
              <input type="date" id="end-date" class="modern-date-input">
            </div>
            <div class="date-actions">
              <button class="action-btn action-apply" id="apply-custom-range">
                <i class="fa fa-check"></i>
                <span>Aplicar</span>
              </button>
              <button class="action-btn action-cancel" id="cancel-custom-range">
                <i class="fa fa-times"></i>
                <span>Cancelar</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-lg-4">
        <div class="action-buttons">
          <button class="action-btn action-export" id="export-btn">
            <i class="fa fa-download"></i>
            <span class="d-none d-lg-inline">Exportar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs principales (Modern Design) -->
  <div class="row g-4 mb-5" id="kpi-cards">
    <div class="col-sm-6 col-lg-3">
      <div class="kpi-card kpi-tickets overflow-hidden position-relative">
        <div class="kpi-background"></div>
        <div class="card-body p-4 position-relative">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="kpi-icon-container">
              <i class="fa fa-ticket-alt kpi-icon"></i>
            </div>
            <div class="kpi-trend trend-neutral" id="kpi-tickets">
              <i class="fa fa-minus fa-sm"></i>
              <span class="small">--</span>
            </div>
          </div>
          <div class="kpi-content">
            <h6 class="kpi-title mb-2">Tickets Activos</h6>
            <div class="d-flex align-items-end">
              <span class="kpi-value" id="kpi-active-tickets">--</span>
              <span class="kpi-unit ms-2">tickets</span>
            </div>
            <div class="kpi-subtitle mt-1">
              <small class="text-muted">En seguimiento</small>
            </div>
          </div>
          <div class="kpi-progress mt-3">
            <div class="progress-bar" style="width: 75%"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
      <div class="kpi-card kpi-time overflow-hidden position-relative">
        <div class="kpi-background"></div>
        <div class="card-body p-4 position-relative">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="kpi-icon-container">
              <i class="fa fa-clock kpi-icon"></i>
            </div>
            <div class="kpi-trend trend-neutral" id="kpi-time">
              <i class="fa fa-minus fa-sm"></i>
              <span class="small">--</span>
            </div>
          </div>
          <div class="kpi-content">
            <h6 class="kpi-title mb-2">Tiempo Promedio</h6>
            <div class="d-flex align-items-end">
              <span class="kpi-value" id="kpi-avg-time">--</span>
            </div>
            <div class="kpi-subtitle mt-1">
              <small class="text-muted">De resolución</small>
            </div>
          </div>
          <div class="kpi-progress mt-3">
            <div class="progress-bar" style="width: 60%"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
      <div class="kpi-card kpi-warranties overflow-hidden position-relative">
        <div class="kpi-background"></div>
        <div class="card-body p-4 position-relative">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="kpi-icon-container">
              <i class="fa fa-shield-alt kpi-icon"></i>
            </div>
            <div class="kpi-trend trend-neutral" id="kpi-warranties">
              <i class="fa fa-minus fa-sm"></i>
              <span class="small">--</span>
            </div>
          </div>
          <div class="kpi-content">
            <h6 class="kpi-title mb-2">Garantías Activas</h6>
            <div class="d-flex align-items-end">
              <span class="kpi-value" id="kpi-active-warranties">--</span>
              <span class="kpi-unit ms-2">casos</span>
            </div>
            <div class="kpi-subtitle mt-1">
              <small class="text-muted">En proceso</small>
            </div>
          </div>
          <div class="kpi-progress mt-3">
            <div class="progress-bar" style="width: 85%"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
      <div class="row g-3 h-100">
        <div class="col-12">
          <div class="kpi-card kpi-revenue-st overflow-hidden position-relative" style="min-height: 140px;">
            <div class="kpi-background"></div>
            <div class="card-body p-3 position-relative">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="kpi-icon-container-small">
                  <i class="fa fa-coins kpi-icon-small"></i>
                </div>
                <div class="kpi-trend-small trend-neutral" id="kpi-revenue-st">
                  <i class="fa fa-minus fa-xs"></i>
                  <span class="small">--</span>
                </div>
              </div>
              <div class="kpi-content">
                <h6 class="kpi-title-small mb-1">Facturado ST</h6>
                <div class="kpi-value-small" id="kpi-facturado-st">--</div>
                <div class="kpi-subtitle-small mt-1">
                  <small class="text-muted">Servicio Técnico</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-12">
          <div class="kpi-card kpi-revenue-ri overflow-hidden position-relative" style="min-height: 140px;">
            <div class="kpi-background"></div>
            <div class="card-body p-3 position-relative">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="kpi-icon-container-small">
                  <i class="fa fa-file-invoice-dollar kpi-icon-small"></i>
                </div>
                <div class="kpi-trend-small trend-neutral" id="kpi-revenue-ri">
                  <i class="fa fa-minus fa-xs"></i>
                  <span class="small">--</span>
                </div>
              </div>
              <div class="kpi-content">
                <h6 class="kpi-title-small mb-1">Facturado RI</h6>
                <div class="kpi-value-small" id="kpi-facturado-ri">--</div>
                <div class="kpi-subtitle-small mt-1">
                  <small class="text-muted">Reparación Interna</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos principales -->
  <div class="charts-section mb-5">
    <!-- Tickets por Técnico (ancho completo) -->
    <div class="row g-4 mb-4">
      <div class="col-12">
        <div class="modern-card">
          <div class="card-header-modern">
            <div class="header-content">
              <div class="header-icon">
                <i class="fa fa-chart-bar"></i>
              </div>
              <div class="header-text">
                <h3 class="card-title">Tickets por Técnico</h3>
                <p class="card-subtitle">Distribución de carga de trabajo</p>
              </div>
            </div>
          </div>
          <div class="card-body-modern">
            <div class="chart-container">
              <canvas id="chart-tickets-technician" height="120"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Top Problemas y Distribución (dos columnas) -->
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="modern-card h-100">
          <div class="card-header-modern">
            <div class="header-content">
              <div class="header-icon">
                <i class="fa fa-exclamation-triangle"></i>
              </div>
              <div class="header-text">
                <h3 class="card-title">Top 5 Problemas</h3>
                <p class="card-subtitle">Issues más comunes</p>
              </div>
            </div>
            <div class="header-actions">
              <button class="chart-action-btn" title="Ver todos">
                <i class="fa fa-external-link-alt"></i>
              </button>
            </div>
          </div>
          <div class="card-body-modern p-0">
            <div class="problems-list-container">
              <ul class="modern-problems-list" id="top-problems-list">
                <li class="loading-item">
                  <div class="loading-content">
                    <div class="loading-spinner-small"></div>
                    <span>Cargando...</span>
                  </div>
                </li>
              </ul>
            </div>
            <div class="modern-pagination-container" id="top-problems-pagination"></div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-lg-6">
        <div class="modern-card h-100">
          <div class="card-header-modern">
            <div class="header-content">
              <div class="header-icon">
                <i class="fa fa-chart-pie"></i>
              </div>
              <div class="header-text">
                <h3 class="card-title">Distribución</h3>
                <p class="card-subtitle">Por tipo de servicio</p>
              </div>
            </div>
          </div>
          <div class="card-body-modern">
            <div class="chart-container">
              <canvas id="chart-tickets-distribution" height="120"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico de línea temporal (oculto para período "today") -->
  <div class="timeline-section mb-5" id="timeline-section" style="display: none;">
    <div class="row">
      <div class="col-12">
        <div class="modern-card">
          <div class="card-header-modern">
            <div class="header-content">
              <div class="header-icon">
                <i class="fa fa-chart-line"></i>
              </div>
              <div class="header-text">
                <h3 class="card-title">Tendencia Temporal</h3>
                <p class="card-subtitle">Evolución de tickets en el tiempo</p>
              </div>
            </div>
          </div>
          <div class="card-body-modern">
            <div class="chart-container">
              <canvas id="chart-timeline" height="80"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de tickets pendientes (adaptable) -->
  <div class="data-section">
    <div class="row g-4">
      <div class="col-12" id="pending-tickets-container">
        <div class="modern-card">
          <div class="card-header-modern">
            <div class="header-content">
              <div class="header-icon">
                <i class="fa fa-list-ul"></i>
              </div>
              <div class="header-text">
                <h3 class="card-title">Tickets Pendientes</h3>
                <p class="card-subtitle">Casos que requieren atención</p>
              </div>
            </div>
          </div>
          <div class="card-body-modern p-0">
            <div class="modern-table-container">
              <table class="modern-table" id="pending-tickets-table">
                <thead class="modern-table-header">
                  <tr>
                    <th class="d-none d-md-table-cell">ID</th>
                    <th>Documento</th>
                    <th class="d-none d-md-table-cell">Producto</th>
                    <th>Estado</th>
                    <th class="d-none d-lg-table-cell">Técnico</th>
                    <th class="d-none d-md-table-cell">Ciudad</th>
                    <th class="d-none d-md-table-cell">Tiempo</th>
                    <th>Prioridad</th>
                    <th class="d-none d-md-table-cell">Tipo</th>
                  </tr>
                </thead>
                <tbody id="pending-tickets-body" class="modern-table-body">
                  <tr class="loading-row">
                    <td colspan="8" class="loading-cell">
                      <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <span>Cargando datos...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modern-pagination-container" id="pending-tickets-pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Librerías JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@coreui/coreui@5.0.0/dist/js/coreui.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

